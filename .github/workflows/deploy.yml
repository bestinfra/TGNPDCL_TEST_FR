name: GMR Frontend Deploy

on:
    push:
        branches:
            - main

jobs:
    deploy:
        runs-on: [self-hosted, tgnpdcl_frn]
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Setup Node
              uses: actions/setup-node@v4
              with:
                  node-version: "18"

            - name: Install
              run: npm ci

            - name: Build
              run: npm run build

            - name: Deploy
              shell: powershell
              run: |
                $target = "C:\xampp_production\htdocs\v2\tgnpdcl_smart"
                $backupPath = "C:\xampp_production\htaccess_backup\.htaccess.bak"
                $htaccess = Join-Path $target ".htaccess"

                # Ensure backup folder exists
                if (!(Test-Path "C:\xampp_production\htaccess_backup")) {
                  New-Item -ItemType Directory -Path "C:\xampp_production\htaccess_backup" | Out-Null
                }

                # Backup .htaccess outside deploy folder
                if (Test-Path $htaccess) {
                  Copy-Item $htaccess $backupPath -Force
                  Write-Host "✅ .htaccess backed up"
                }

                robocopy dist $target /MIR /XF ".htaccess" /R:10 /W:5
                $code = $LASTEXITCODE

                # Restore .htaccess
                if (Test-Path $backupPath) {
                  Copy-Item $backupPath $htaccess -Force
                  Write-Host "✅ .htaccess restored"
                }

                # Exit robocopy exit code correctly
                if ($code -le 1) { exit 0 } else { exit $code }